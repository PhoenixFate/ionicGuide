import { Component, ViewChild, ElementRef } from '@angular/core';
import { NavController, Platform } from 'ionic-angular';
import { ScenicSpotPage } from '../scenic-spot/scenic-spot';
import { Http } from '@angular/http';
import $ from 'jquery';

declare var BMap;

@Component({
  selector: 'page-home',
  templateUrl: 'home.html'
})


export class HomePage {

  @ViewChild('map') map_container: ElementRef;
  map: any;
  public scenicSpotPage = ScenicSpotPage;
  constructor(public navCtrl: NavController, private platform: Platform, public http: Http) {
    // this.CreateBaiduMap();
  }


  //ionViewDidEnter
  ionViewDidEnter() {
    //创建百度Map实例
    let map = this.map = new BMap.Map(this.map_container.nativeElement, { enableClick: true });
    //添加控件
    map.addControl(new BMap.NavigationControl());
    map.addControl(new BMap.ScaleControl());
    map.addControl(new BMap.OverviewMapControl());
    // map.addControl(new BMap.MapTypeControl({mapTypes:["BMAP_NORMAL_MAP","BMAP_HYBRID_MAP"]}));
    map.addControl(new BMap.MapTypeControl());

    let point = new BMap.Point(113.332871, 24.819071);
    //设置中心点
    map.centerAndZoom(point, 17);

    //启动滚动放大缩小，默认禁用
    map.enableScrollWheelZoom(true);

    var points = [{
      id: 1,
      lng: 116.404,
      lat: 39.915,
      name: "文化长廊"
    },
    {
      id: 2,
      lng: 116.41,
      lat: 39.92,
      name: "展板区域"
    },
    {
      id: 3,
      lng: 116.407,
      lat: 39.90,
      name: "VR体验区"
    },
    {
      id: 4,
      lng: 116.393,
      lat: 39.905,
      name: "4D电影体验区"
    },
    {
      id: 5,
      lng: 116.392,
      lat: 39.92,
      name: "游戏区"
    },
    {
      id: 6,
      lng: 116.385,
      lat: 39.885,
      name: "教育区"
    },
    {
      id: 7,
      lng: 116.389,
      lat: 39.95,
      name: "展馆"
    },
    ];
    var that = this;
    var myIcon = new BMap.Icon("assets/imgs/red-marker.png", new BMap.Size(33, 35));
    let url = "https://njrzzk.com/app/a/app/tblScenicspot/getlist";
    this.http.get(url).subscribe(data => {
      let temp = JSON.parse(data['_body']).rows;
      console.log(temp);
      for (let i = 0; i < temp.length; i++) {
        let lonlat = temp[i].lonLat;
        let arr = [];
        arr = lonlat.split(',');
        let point = new BMap.Point(arr[0], arr[1]);
        var marker = new BMap.Marker(point);
        marker.setIcon(myIcon);
        map.addOverlay(marker);
        (function () {
          var thePoint = temp[i];
          marker.addEventListener("click", function () {
            that.showInfo(this, thePoint);
          });
        })();
      }
    }, err => {

    });

    // for (var i = 0; i < points.length; i++) {
    //   let point = new BMap.Point(points[i].lng, points[i].lat);
    //   var marker = new BMap.Marker(point);
    //   marker.setIcon(myIcon);
    //   map.addOverlay(marker);
    //   (function () {
    //     var thePoint = points[i];
    //     marker.addEventListener("click", function () {
    //       that.showInfo(this, thePoint);
    //     });
    //   })();
    // }
  }


  showInfo(thisMaker, point) {
    var that = this;
    var sContent =
      '<ul style="margin:0 0 5px 0;padding:0.2em 0;z-index:100" id="more">'
      + '<li style="line-height: 26px;font-size: 15px;">'
      + '<span style="width: 50px;display: inline-block;">名称：</span>' + point.name + '</li>'
      + '<li   style="line-height: 26px;font-size: 15px;"><span style="width: 50px;display: inline-block;">查看：</span><button>详情</button></li>'
      + '</ul>';

    var infoWindow = new BMap.InfoWindow(sContent);  // 创建信息窗口对象

    thisMaker.openInfoWindow(infoWindow);   //图片加载完毕重绘infowindow
    //web点击事件为click，手机端点击事件为touchstart
    infoWindow.addEventListener('open', function () {
      $('.BMap_bubble_content').bind("click", function () {
        that.navCtrl.push(ScenicSpotPage, { "id": point.id });
      });
      $('.BMap_bubble_content').bind("touchstart", function () {
        that.navCtrl.push(ScenicSpotPage, { "id": point.id });
      });
    })
    $('#more').bind("click", function () {
      that.navCtrl.push(ScenicSpotPage, { "id": point.id });
    })
    $('#more').bind("touchstart", function () {
      that.navCtrl.push(ScenicSpotPage, { "id": point.id });
    })
  };

  toScenicSpot(id) {
    this.navCtrl.push(ScenicSpotPage, { "id": id });
  }
}



